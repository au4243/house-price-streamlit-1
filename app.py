<<<<<<< HEAD
import streamlit as st
import os
import json

from predict import HousePricePredictor

# =========================
# é é¢è¨­å®š
# =========================
st.set_page_config(
    page_title="æˆ¿åƒ¹ä¼°åƒ¹ç³»çµ±",
    page_icon="ðŸ ",
    layout="centered",
)

st.title("ðŸ  æˆ¿åƒ¹ä¼°åƒ¹èˆ‡ SHAP è§£é‡‹ç³»çµ±")
st.caption("XGBoost + å¯è§£é‡‹ AIï¼ˆSHAPï¼‰ï½œä¾æ“š 114 å¹´ Q1~Q3 ä¸å‹•ç”¢æˆäº¤è³‡æ–™")

# =========================
# è¡Œæ”¿å€å°ç…§è¡¨
# =========================
CITY_TOWN_MAP = {
    "è‡ºåŒ—å¸‚": [
        "å£«æž—å€",
        "å¤§åŒå€",
        "å¤§å®‰å€",
        "ä¸­å±±å€",
        "ä¸­æ­£å€",
        "å…§æ¹–å€",
        "æ–‡å±±å€",
        "åŒ—æŠ•å€",
        "æ¾å±±å€",
        "ä¿¡ç¾©å€",
        "å—æ¸¯å€",
        "è¬è¯å€",
    ],
    "æ–°åŒ—å¸‚": [
        "å…«é‡Œå€",
        "ä¸‰èŠå€",
        "ä¸‰é‡å€",
        "ä¸‰å³½å€",
        "åœŸåŸŽå€",
        "ä¸­å’Œå€",
        "äº”è‚¡å€",
        "å¹³æºªå€",
        "æ°¸å’Œå€",
        "çŸ³é–€å€",
        "çŸ³ç¢‡å€",
        "æ±æ­¢å€",
        "åªæž—å€",
        "æ¿æ©‹å€",
        "æž—å£å€",
        "é‡‘å±±å€",
        "æ³°å±±å€",
        "çƒä¾†å€",
        "è²¢å¯®å€",
        "æ·¡æ°´å€",
        "æ·±å‘å€",
        "æ–°åº—å€",
        "æ–°èŽŠå€",
        "ç‘žèŠ³å€",
        "è¬é‡Œå€",
        "æ¨¹æž—å€",
        "é›™æºªå€",
        "è˜†æ´²å€",
        "é¶¯æ­Œå€",
    ],
    "æ¡ƒåœ’å¸‚": [
        "å…«å¾·å€",
        "å¤§åœ’å€",
        "å¤§æºªå€",
        "ä¸­å£¢å€",
        "å¹³éŽ®å€",
        "æ¡ƒåœ’å€",
        "å¾©èˆˆå€",
        "æ–°å±‹å€",
        "æ¥Šæ¢…å€",
        "é¾æ½­å€",
        "é¾œå±±å€",
        "è˜†ç«¹å€",
        "è§€éŸ³å€",
    ],
    "æ–°ç«¹ç¸£": [
        "äº”å³°é„‰",
        "åŒ—åŸ”é„‰",
        "å°–çŸ³é„‰",
        "ç«¹åŒ—å¸‚",
        "ç«¹æ±éŽ®",
        "èŠŽæž—é„‰",
        "å³¨çœ‰é„‰",
        "æ¹–å£é„‰",
        "æ–°åŸ”éŽ®",
        "æ–°è±é„‰",
        "æ©«å±±é„‰",
        "é—œè¥¿éŽ®",
        "å¯¶å±±é„‰",
    ],    
    "è‹—æ —ç¸£": [
        "ä¸‰ç¾©é„‰",
        "ä¸‰ç£é„‰",
        "å¤§æ¹–é„‰",
        "å…¬é¤¨é„‰",
        "ç«¹å—éŽ®",
        "è¥¿æ¹–é„‰",
        "å“è˜­éŽ®",
        "å—åº„é„‰",
        "å¾Œé¾éŽ®",
        "è‹‘è£¡éŽ®",
        "è‹—æ —å¸‚",
        "æ³°å®‰é„‰",
        "é€šéœ„éŽ®",
        "é€ æ©‹é„‰",
        "ç…æ½­é„‰",
        "éŠ…é‘¼é„‰",
        "é ­ä»½å¸‚",
        "é ­å±‹é„‰",
    ],    
    "è‡ºä¸­å¸‚": [
        "å¤§ç”²å€",
        "å¤§å®‰å€",
        "å¤§è‚šå€",
        "å¤§é‡Œå€",
        "å¤§é›…å€",
        "ä¸­å€",
        "å¤ªå¹³å€",
        "åŒ—å±¯å€",
        "åŒ—å€",
        "å¤–åŸ”å€",
        "çŸ³å²¡å€",
        "åŽé‡Œå€",
        "è¥¿å±¯å€",
        "è¥¿å€",
        "æ²™é¹¿å€",
        "å’Œå¹³å€",
        "æ±å€",
        "æ±å‹¢å€",
        "å—å±¯å€",
        "å—å€",
        "çƒæ—¥å€",
        "ç¥žå²¡å€",
        "æ¢§æ£²å€",
        "æ¸…æ°´å€",
        "æ–°ç¤¾å€",
        "æ½­å­å€",
        "é¾äº•å€",
        "è±åŽŸå€",
        "éœ§å³°å€",
    ],            
    "å—æŠ•ç¸£": [
        "ä¸­å¯®é„‰",
        "ä»æ„›é„‰",
        "æ°´é‡Œé„‰",
        "åé–“é„‰",
        "ç«¹å±±éŽ®",
        "ä¿¡ç¾©é„‰",
        "å—æŠ•å¸‚",
        "åŸ”é‡ŒéŽ®",
        "è‰å±¯éŽ®",
        "åœ‹å§“é„‰",
        "é­šæ± é„‰",
        "é¹¿è°·é„‰",
        "é›†é›†éŽ®",
    ],                
    "å½°åŒ–ç¸£": [
        "äºŒæ°´é„‰",
        "äºŒæž—éŽ®",
        "å¤§æ‘é„‰",
        "å¤§åŸŽé„‰",
        "åŒ—æ–—éŽ®",
        "æ°¸é–é„‰",
        "ç”°ä¸­éŽ®",
        "ç”°å°¾é„‰",
        "ç«¹å¡˜é„‰",
        "ä¼¸æ¸¯é„‰",
        "ç§€æ°´é„‰",
        "å’Œç¾ŽéŽ®",
        "ç¤¾é ­é„‰",
        "èŠ¬åœ’é„‰",
        "èŠ±å£‡é„‰",
        "èŠ³è‹‘é„‰",
        "å“¡æž—å¸‚",
        "åŸ”å¿ƒé„‰",
        "åŸ”é¹½é„‰",
        "åŸ¤é ­é„‰",
        "é¹¿æ¸¯éŽ®",
        "æºªå·žé„‰",
        "æºªæ¹–éŽ®",
        "å½°åŒ–å¸‚",
        "ç¦èˆˆé„‰",
        "ç·šè¥¿é„‰",
    ],           
    "é›²æž—ç¸£": [
        "äºŒå´™é„‰",
        "å£æ¹–é„‰",
        "åœŸåº«éŽ®",
        "å¤§åŸ¤é„‰",
        "å…ƒé•·é„‰",
        "æ–—å…­å¸‚",
        "æ–—å—éŽ®",
        "æ°´æž—é„‰",
        "åŒ—æ¸¯éŽ®",
        "å¤å‘é„‰",
        "å››æ¹–é„‰",
        "è¥¿èžºéŽ®",
        "æ±å‹¢é„‰",
        "æž—å…§é„‰",
        "è™Žå°¾éŽ®",
        "å´™èƒŒé„‰",
        "éº¥å¯®é„‰",
        "èŽ¿æ¡é„‰",
        "è‡ºè¥¿é„‰",
        "è¤’å¿ é„‰",
    ],           
    "å˜‰ç¾©ç¸£": [
        "å¤§æž—éŽ®",
        "å¤§åŸ”é„‰",
        "ä¸­åŸ”é„‰",
        "å…­è…³é„‰",
        "å¤ªä¿å¸‚",
        "æ°´ä¸Šé„‰",
        "å¸ƒè¢‹éŽ®",
        "æ°‘é›„é„‰",
        "æœ´å­å¸‚",
        "ç«¹å´Žé„‰",
        "æ±çŸ³é„‰",
        "é˜¿é‡Œå±±é„‰",
        "æ¢…å±±é„‰",
        "é¹¿è‰é„‰",
        "ç•ªè·¯é„‰",
        "æ–°æ¸¯é„‰",
        "æºªå£é„‰",
        "ç¾©ç«¹é„‰",
    ],            
    "è‡ºå—å¸‚": [
        "ä¸ƒè‚¡å€",
        "ä¸‹ç‡Ÿå€",
        "å¤§å…§å€",
        "å±±ä¸Šå€",
        "ä¸­è¥¿å€",
        "ä»å¾·å€",
        "å…­ç”²å€",
        "åŒ—é–€å€",
        "åŒ—å€",
        "å·¦éŽ®å€",
        "æ°¸åº·å€",
        "çŽ‰äº•å€",
        "ç™½æ²³å€",
        "å®‰å¹³å€",
        "å®‰å®šå€",
        "å®‰å—å€",
        "è¥¿æ¸¯å€",
        "ä½³é‡Œå€",
        "å®˜ç”°å€",
        "æ±å±±å€",
        "æ±å€",
        "å—åŒ–å€",
        "å—å€",
        "å¾Œå£å€",
        "æŸ³ç‡Ÿå€",
        "å°‡è»å€",
        "éº»è±†å€",
        "å–„åŒ–å€",
        "æ–°åŒ–å€",
        "æ–°å¸‚å€",
        "æ–°ç‡Ÿå€",
        "æ¥ è¥¿å€",
        "å­¸ç”²å€",
        "é¾å´Žå€",
        "æ­¸ä»å€",
        "é—œå»Ÿå€",
        "é¹½æ°´å€",
    ],            
    "é«˜é›„å¸‚": [
        "ä¸‰æ°‘å€",
        "å¤§ç¤¾å€",
        "å¤§å¯®å€",
        "å¤§æ¨¹å€",
        "å°æ¸¯å€",
        "ä»æ­¦å€",
        "å…§é–€å€",
        "å…­é¾œå€",
        "å·¦ç‡Ÿå€",
        "æ°¸å®‰å€",
        "ç”°å¯®å€",
        "ç”²ä»™å€",
        "æ‰æž—å€",
        "é‚£ç‘ªå¤å€",
        "å²¡å±±å€",
        "æž—åœ’å€",
        "é˜¿è“®å€",
        "å‰é‡‘å€",
        "å‰éŽ®å€",
        "ç¾Žæ¿ƒå€",
        "è‹“é›…å€",
        "èŒ‚æž—å€",
        "èŒ„è£å€",
        "æ¡ƒæºå€",
        "æ¢“å®˜å€",
        "é³¥æ¾å€",
        "æ¹–å…§å€",
        "æ–°èˆˆå€",
        "æ¥ æ¢“å€",
        "è·¯ç«¹å€",
        "é¼“å±±å€",
        "æ——å±±å€",
        "æ——æ´¥å€",
        "é³³å±±å€",
        "æ©‹é ­å€",
        "ç‡•å·¢å€",
        "å½Œé™€å€",
        "é¹½åŸ•å€",
    ],                
    "å±æ±ç¸£": [
        "ä¹å¦‚é„‰",
        "ä¸‰åœ°é–€é„‰",
        "å…§åŸ”é„‰",
        "ç«¹ç”°é„‰",
        "ç‰¡ä¸¹é„‰",
        "è»ŠåŸŽé„‰",
        "é‡Œæ¸¯é„‰",
        "ä½³å†¬é„‰",
        "ä¾†ç¾©é„‰",
        "æ±æ¸¯éŽ®",
        "æž‹å±±é„‰",
        "æž‹å¯®é„‰",
        "æž—é‚Šé„‰",
        "é•·æ²»é„‰",
        "å—å·žé„‰",
        "å±æ±å¸‚",
        "æ†æ˜¥éŽ®",
        "æ˜¥æ—¥é„‰",
        "å´é ‚é„‰",
        "æ³°æ­¦é„‰",
        "ç‰çƒé„‰",
        "é«˜æ¨¹é„‰",
        "æ–°åŸ¤é„‰",
        "æ–°åœ’é„‰",
        "ç…å­é„‰",
        "è¬ä¸¹é„‰",
        "è¬å·’é„‰",
        "æ»¿å·žé„‰",
        "ç‘ªå®¶é„‰",
        "æ½®å·žéŽ®",
        "éœ§è‡ºé„‰",
        "éºŸæ´›é„‰",
        "é¹½åŸ”é„‰",
    ],       
    "å®œè˜­ç¸£": [
        "ä¸‰æ˜Ÿé„‰",
        "å¤§åŒé„‰",
        "äº”çµé„‰",
        "å†¬å±±é„‰",
        "å£¯åœé„‰",
        "å®œè˜­å¸‚",
        "å—æ¾³é„‰",
        "å“¡å±±é„‰",
        "é ­åŸŽéŽ®",
        "ç¤æºªé„‰",
        "ç¾…æ±éŽ®",
        "è˜‡æ¾³éŽ®",
    ],                    
    "èŠ±è“®ç¸£": [
        "çŽ‰é‡ŒéŽ®",
        "å…‰å¾©é„‰",
        "å‰å®‰é„‰",
        "ç§€æž—é„‰",
        "å“æºªé„‰",
        "èŠ±è“®å¸‚",
        "å¯Œé‡Œé„‰",
        "æ–°åŸŽé„‰",
        "ç‘žç©—é„‰",
        "è¬æ¦®é„‰",
        "å£½è±é„‰",
        "é³³æž—éŽ®",
        "è±æ¿±é„‰",        
    ],                    
    "è‡ºæ±ç¸£": [
        "å¤§æ­¦é„‰",
        "å¤ªéº»é‡Œé„‰",
        "æˆåŠŸéŽ®",
        "æ± ä¸Šé„‰",
        "å‘å—é„‰",
        "å»¶å¹³é„‰",
        "æ±æ²³é„‰",
        "é‡‘å³°é„‰",
        "é•·æ¿±é„‰",
        "æµ·ç«¯é„‰",
        "é¹¿é‡Žé„‰",
        "é”ä»é„‰",
        "ç¶ å³¶é„‰",
        "è‡ºæ±å¸‚",
        "é—œå±±éŽ®",
        "è˜­å¶¼é„‰",
    ],          
    "åŸºéš†å¸‚": [
        "ä¸ƒå µå€",
        "ä¸­å±±å€",
        "ä¸­æ­£å€",
        "ä»æ„›å€",
        "å®‰æ¨‚å€",
        "ä¿¡ç¾©å€",
        "æš–æš–å€",
    ],    
    "æ–°ç«¹å¸‚": [
        "åŒ—å€",
        "æ±å€",
        "é¦™å±±å€",        
    ],    
    "å˜‰ç¾©å¸‚": [
        "è¥¿å€",
        "æ±å€",
    ],  
    "æ¾Žæ¹–ç¸£": [
        "ä¸ƒç¾Žé„‰",
        "ç™½æ²™é„‰",
        "è¥¿å¶¼é„‰",
        "é¦¬å…¬å¸‚",
        "æœ›å®‰é„‰",
        "æ¹–è¥¿é„‰",
    ],    
    "é‡‘é–€ç¸£": [
        "é‡‘æ²™éŽ®",
        "é‡‘åŸŽéŽ®",
        "é‡‘æ¹–éŽ®",
        "é‡‘å¯§é„‰",
        "çƒˆå¶¼é„‰",
        "çƒåµé„‰",
    ],
    "é€£æ±Ÿç¸£": [
        "åŒ—ç«¿é„‰",
        "æ±å¼•é„‰",
        "å—ç«¿é„‰",
        "èŽ’å…‰é„‰",
    ],
    
}
# =========================
# è¼‰å…¥æ¨¡åž‹ï¼ˆå¿«å–ï¼‰
# =========================
@st.cache_resource
def load_predictor():
    return HousePricePredictor()

predictor = load_predictor()

# =========================
# å´é‚Šæ¬„è¼¸å…¥
# =========================
st.sidebar.header("ðŸ“‹ æˆ¿å±‹åŸºæœ¬è³‡æ–™")

# --- è¡Œæ”¿å€ï¼ˆæ‹†æˆå…©æ¬„ï¼‰ ---
city = st.sidebar.selectbox(
    "ç¸£å¸‚",
    list(CITY_TOWN_MAP.keys()),
)

town = st.sidebar.selectbox(
    "é„‰éŽ®å¸‚å€",
    CITY_TOWN_MAP[city],
)

# â­ åˆä½µæˆæ¨¡åž‹éœ€è¦çš„æ ¼å¼
district = f"{city}{town}"
st.sidebar.caption(f"ðŸ“ è¡Œæ”¿å€ï¼š{district}")

# --- å…¶ä»–æ¬„ä½ ---
building_type = st.sidebar.selectbox(
    "å»ºç‰©åž‹æ…‹",
    ["ä½å®…å¤§æ¨“", "è¯å»ˆ", "å…¬å¯“", "é€å¤©åŽ"],
)

main_use = st.sidebar.selectbox(
    "ä¸»è¦ç”¨é€”",
    ["ä½å®¶ç”¨", "å•†æ¥­ç”¨", "ä½å•†ç”¨"],
)

building_age = st.sidebar.number_input(
    "å±‹é½¡ï¼ˆå¹´ï¼‰",
    min_value=0,
    max_value=80,
    value=20,
)

main_area = st.sidebar.number_input(
    "ä¸»å»ºç‰©é¢ç©ï¼ˆåªï¼‰",
    min_value=5.0,
    max_value=100.0,
    value=30.0,
)

balcony_area = st.sidebar.number_input(
    "é™½å°é¢ç©ï¼ˆåªï¼‰",
    min_value=0.0,
    max_value=20.0,
    value=5.0,
)

floor = st.sidebar.number_input(
    "æ‰€åœ¨æ¨“å±¤",
    min_value=1,
    max_value=100,
    value=5,
)

total_floors = st.sidebar.number_input(
    "ç¸½æ¨“å±¤æ•¸",
    min_value=1,
    max_value=100,
    value=10,
)

has_parking = st.sidebar.radio(
    "æ˜¯å¦æœ‰è»Šä½",
    ["æœ‰", "ç„¡"],
)

has_elevator = st.sidebar.radio(
    "æ˜¯å¦æœ‰é›»æ¢¯",
    ["æœ‰", "ç„¡"],
)

# =========================
# çµ„åˆè¼¸å…¥è³‡æ–™
# =========================
case_dict = {
    "district": district,
    "building_type": building_type,
    "main_use": main_use,
    "building_age": building_age,
    "building_area_sqm": main_area * 3.3058,
    "floor": floor,
    "total_floors": total_floors,
    "main_area": main_area,
    "balcony_area": balcony_area,
    "has_parking": 1 if has_parking == "æœ‰" else 0,
    "has_elevator": 1 if has_elevator == "æœ‰" else 0,
}

# =========================
# ä¸»ç•«é¢
# =========================
st.subheader("ðŸ“Š é æ¸¬çµæžœ")

if st.button("ðŸš€ é–‹å§‹ä¼°åƒ¹"):

    with st.spinner("æ¨¡åž‹é æ¸¬ä¸­ï¼Œè«‹ç¨å€™..."):
        output_dir = predictor.export_prediction_bundle(case_dict)

    # --- è®€å–çµæžœ ---
    with open(os.path.join(output_dir, "prediction.json"), encoding="utf-8") as f:
        summary = json.load(f)

    with open(os.path.join(output_dir, "explanation.txt"), encoding="utf-8") as f:
        explanation = f.read()

    # ====== é¡¯ç¤ºé æ¸¬åƒ¹æ ¼ ======
    st.success(f"ðŸ’° é æ¸¬å–®åƒ¹ï¼šç´„ **{summary['predicted_price_wan_per_ping']} è¬ / åª**")

    # ====== SHAP åœ– ======
    st.subheader("ðŸ” åƒ¹æ ¼å½±éŸ¿å› ç´ ï¼ˆSHAPï¼‰")
    st.image(
        os.path.join(output_dir, "shap_waterfall.png"),
        use_container_width=True,
    )

    # ====== ä¸­æ–‡è§£é‡‹ ======
    st.subheader("ðŸ“ ä¸­æ–‡ä¼°åƒ¹èªªæ˜Ž")
    st.text(explanation)

    # ====== ä¸‹è¼‰å€ ======
    st.subheader("â¬‡ï¸ ä¸‹è¼‰çµæžœ")

    with open(os.path.join(output_dir, "explanation.txt"), "rb") as f:
        st.download_button(
            "ðŸ“„ ä¸‹è¼‰ä¼°åƒ¹èªªæ˜Žï¼ˆTXTï¼‰",
            f,
            file_name="prediction.txt",
        )

    with open(os.path.join(output_dir, "shap_waterfall.png"), "rb") as f:
        st.download_button(
            "ðŸ–¼ï¸ ä¸‹è¼‰ SHAP åœ–ï¼ˆPNGï¼‰",
            f,
            file_name="shap_waterfall.png",
        )

    with open(os.path.join(output_dir, "prediction.json"), "rb") as f:
        st.download_button(
            "ðŸ“¦ ä¸‹è¼‰ JSONï¼ˆAPI ç”¨ï¼‰",
            f,
            file_name="prediction.json",
        )

=======
import streamlit as st
import os
import json

from predict import HousePricePredictor

# =========================
# é é¢è¨­å®š
# =========================
st.set_page_config(
    page_title="æˆ¿åƒ¹ä¼°åƒ¹ç³»çµ±",
    page_icon="ðŸ ",
    layout="centered",
)

st.title("ðŸ  æˆ¿åƒ¹ä¼°åƒ¹èˆ‡ SHAP è§£é‡‹ç³»çµ±")
st.caption("XGBoost + å¯è§£é‡‹ AIï¼ˆSHAPï¼‰ï½œä¾æ“š 114 å¹´ Q1~Q3 ä¸å‹•ç”¢æˆäº¤è³‡æ–™")

# =========================
# è¡Œæ”¿å€å°ç…§è¡¨
# =========================
CITY_TOWN_MAP = {
    "è‡ºåŒ—å¸‚": [
        "å£«æž—å€",
        "å¤§åŒå€",
        "å¤§å®‰å€",
        "ä¸­å±±å€",
        "ä¸­æ­£å€",
        "å…§æ¹–å€",
        "æ–‡å±±å€",
        "åŒ—æŠ•å€",
        "æ¾å±±å€",
        "ä¿¡ç¾©å€",
        "å—æ¸¯å€",
        "è¬è¯å€",
    ],
    "æ–°åŒ—å¸‚": [
        "å…«é‡Œå€",
        "ä¸‰èŠå€",
        "ä¸‰é‡å€",
        "ä¸‰å³½å€",
        "åœŸåŸŽå€",
        "ä¸­å’Œå€",
        "äº”è‚¡å€",
        "å¹³æºªå€",
        "æ°¸å’Œå€",
        "çŸ³é–€å€",
        "çŸ³ç¢‡å€",
        "æ±æ­¢å€",
        "åªæž—å€",
        "æ¿æ©‹å€",
        "æž—å£å€",
        "é‡‘å±±å€",
        "æ³°å±±å€",
        "çƒä¾†å€",
        "è²¢å¯®å€",
        "æ·¡æ°´å€",
        "æ·±å‘å€",
        "æ–°åº—å€",
        "æ–°èŽŠå€",
        "ç‘žèŠ³å€",
        "è¬é‡Œå€",
        "æ¨¹æž—å€",
        "é›™æºªå€",
        "è˜†æ´²å€",
        "é¶¯æ­Œå€",
    ],
    "æ¡ƒåœ’å¸‚": [
        "å…«å¾·å€",
        "å¤§åœ’å€",
        "å¤§æºªå€",
        "ä¸­å£¢å€",
        "å¹³éŽ®å€",
        "æ¡ƒåœ’å€",
        "å¾©èˆˆå€",
        "æ–°å±‹å€",
        "æ¥Šæ¢…å€",
        "é¾æ½­å€",
        "é¾œå±±å€",
        "è˜†ç«¹å€",
        "è§€éŸ³å€",
    ],
    "æ–°ç«¹ç¸£": [
        "äº”å³°é„‰",
        "åŒ—åŸ”é„‰",
        "å°–çŸ³é„‰",
        "ç«¹åŒ—å¸‚",
        "ç«¹æ±éŽ®",
        "èŠŽæž—é„‰",
        "å³¨çœ‰é„‰",
        "æ¹–å£é„‰",
        "æ–°åŸ”éŽ®",
        "æ–°è±é„‰",
        "æ©«å±±é„‰",
        "é—œè¥¿éŽ®",
        "å¯¶å±±é„‰",
    ],    
    "è‹—æ —ç¸£": [
        "ä¸‰ç¾©é„‰",
        "ä¸‰ç£é„‰",
        "å¤§æ¹–é„‰",
        "å…¬é¤¨é„‰",
        "ç«¹å—éŽ®",
        "è¥¿æ¹–é„‰",
        "å“è˜­éŽ®",
        "å—åº„é„‰",
        "å¾Œé¾éŽ®",
        "è‹‘è£¡éŽ®",
        "è‹—æ —å¸‚",
        "æ³°å®‰é„‰",
        "é€šéœ„éŽ®",
        "é€ æ©‹é„‰",
        "ç…æ½­é„‰",
        "éŠ…é‘¼é„‰",
        "é ­ä»½å¸‚",
        "é ­å±‹é„‰",
    ],    
    "è‡ºä¸­å¸‚": [
        "å¤§ç”²å€",
        "å¤§å®‰å€",
        "å¤§è‚šå€",
        "å¤§é‡Œå€",
        "å¤§é›…å€",
        "ä¸­å€",
        "å¤ªå¹³å€",
        "åŒ—å±¯å€",
        "åŒ—å€",
        "å¤–åŸ”å€",
        "çŸ³å²¡å€",
        "åŽé‡Œå€",
        "è¥¿å±¯å€",
        "è¥¿å€",
        "æ²™é¹¿å€",
        "å’Œå¹³å€",
        "æ±å€",
        "æ±å‹¢å€",
        "å—å±¯å€",
        "å—å€",
        "çƒæ—¥å€",
        "ç¥žå²¡å€",
        "æ¢§æ£²å€",
        "æ¸…æ°´å€",
        "æ–°ç¤¾å€",
        "æ½­å­å€",
        "é¾äº•å€",
        "è±åŽŸå€",
        "éœ§å³°å€",
    ],            
    "å—æŠ•ç¸£": [
        "ä¸­å¯®é„‰",
        "ä»æ„›é„‰",
        "æ°´é‡Œé„‰",
        "åé–“é„‰",
        "ç«¹å±±éŽ®",
        "ä¿¡ç¾©é„‰",
        "å—æŠ•å¸‚",
        "åŸ”é‡ŒéŽ®",
        "è‰å±¯éŽ®",
        "åœ‹å§“é„‰",
        "é­šæ± é„‰",
        "é¹¿è°·é„‰",
        "é›†é›†éŽ®",
    ],                
    "å½°åŒ–ç¸£": [
        "äºŒæ°´é„‰",
        "äºŒæž—éŽ®",
        "å¤§æ‘é„‰",
        "å¤§åŸŽé„‰",
        "åŒ—æ–—éŽ®",
        "æ°¸é–é„‰",
        "ç”°ä¸­éŽ®",
        "ç”°å°¾é„‰",
        "ç«¹å¡˜é„‰",
        "ä¼¸æ¸¯é„‰",
        "ç§€æ°´é„‰",
        "å’Œç¾ŽéŽ®",
        "ç¤¾é ­é„‰",
        "èŠ¬åœ’é„‰",
        "èŠ±å£‡é„‰",
        "èŠ³è‹‘é„‰",
        "å“¡æž—å¸‚",
        "åŸ”å¿ƒé„‰",
        "åŸ”é¹½é„‰",
        "åŸ¤é ­é„‰",
        "é¹¿æ¸¯éŽ®",
        "æºªå·žé„‰",
        "æºªæ¹–éŽ®",
        "å½°åŒ–å¸‚",
        "ç¦èˆˆé„‰",
        "ç·šè¥¿é„‰",
    ],           
    "é›²æž—ç¸£": [
        "äºŒå´™é„‰",
        "å£æ¹–é„‰",
        "åœŸåº«éŽ®",
        "å¤§åŸ¤é„‰",
        "å…ƒé•·é„‰",
        "æ–—å…­å¸‚",
        "æ–—å—éŽ®",
        "æ°´æž—é„‰",
        "åŒ—æ¸¯éŽ®",
        "å¤å‘é„‰",
        "å››æ¹–é„‰",
        "è¥¿èžºéŽ®",
        "æ±å‹¢é„‰",
        "æž—å…§é„‰",
        "è™Žå°¾éŽ®",
        "å´™èƒŒé„‰",
        "éº¥å¯®é„‰",
        "èŽ¿æ¡é„‰",
        "è‡ºè¥¿é„‰",
        "è¤’å¿ é„‰",
    ],           
    "å˜‰ç¾©ç¸£": [
        "å¤§æž—éŽ®",
        "å¤§åŸ”é„‰",
        "ä¸­åŸ”é„‰",
        "å…­è…³é„‰",
        "å¤ªä¿å¸‚",
        "æ°´ä¸Šé„‰",
        "å¸ƒè¢‹éŽ®",
        "æ°‘é›„é„‰",
        "æœ´å­å¸‚",
        "ç«¹å´Žé„‰",
        "æ±çŸ³é„‰",
        "é˜¿é‡Œå±±é„‰",
        "æ¢…å±±é„‰",
        "é¹¿è‰é„‰",
        "ç•ªè·¯é„‰",
        "æ–°æ¸¯é„‰",
        "æºªå£é„‰",
        "ç¾©ç«¹é„‰",
    ],            
    "è‡ºå—å¸‚": [
        "ä¸ƒè‚¡å€",
        "ä¸‹ç‡Ÿå€",
        "å¤§å…§å€",
        "å±±ä¸Šå€",
        "ä¸­è¥¿å€",
        "ä»å¾·å€",
        "å…­ç”²å€",
        "åŒ—é–€å€",
        "åŒ—å€",
        "å·¦éŽ®å€",
        "æ°¸åº·å€",
        "çŽ‰äº•å€",
        "ç™½æ²³å€",
        "å®‰å¹³å€",
        "å®‰å®šå€",
        "å®‰å—å€",
        "è¥¿æ¸¯å€",
        "ä½³é‡Œå€",
        "å®˜ç”°å€",
        "æ±å±±å€",
        "æ±å€",
        "å—åŒ–å€",
        "å—å€",
        "å¾Œå£å€",
        "æŸ³ç‡Ÿå€",
        "å°‡è»å€",
        "éº»è±†å€",
        "å–„åŒ–å€",
        "æ–°åŒ–å€",
        "æ–°å¸‚å€",
        "æ–°ç‡Ÿå€",
        "æ¥ è¥¿å€",
        "å­¸ç”²å€",
        "é¾å´Žå€",
        "æ­¸ä»å€",
        "é—œå»Ÿå€",
        "é¹½æ°´å€",
    ],            
    "é«˜é›„å¸‚": [
        "ä¸‰æ°‘å€",
        "å¤§ç¤¾å€",
        "å¤§å¯®å€",
        "å¤§æ¨¹å€",
        "å°æ¸¯å€",
        "ä»æ­¦å€",
        "å…§é–€å€",
        "å…­é¾œå€",
        "å·¦ç‡Ÿå€",
        "æ°¸å®‰å€",
        "ç”°å¯®å€",
        "ç”²ä»™å€",
        "æ‰æž—å€",
        "é‚£ç‘ªå¤å€",
        "å²¡å±±å€",
        "æž—åœ’å€",
        "é˜¿è“®å€",
        "å‰é‡‘å€",
        "å‰éŽ®å€",
        "ç¾Žæ¿ƒå€",
        "è‹“é›…å€",
        "èŒ‚æž—å€",
        "èŒ„è£å€",
        "æ¡ƒæºå€",
        "æ¢“å®˜å€",
        "é³¥æ¾å€",
        "æ¹–å…§å€",
        "æ–°èˆˆå€",
        "æ¥ æ¢“å€",
        "è·¯ç«¹å€",
        "é¼“å±±å€",
        "æ——å±±å€",
        "æ——æ´¥å€",
        "é³³å±±å€",
        "æ©‹é ­å€",
        "ç‡•å·¢å€",
        "å½Œé™€å€",
        "é¹½åŸ•å€",
    ],                
    "å±æ±ç¸£": [
        "ä¹å¦‚é„‰",
        "ä¸‰åœ°é–€é„‰",
        "å…§åŸ”é„‰",
        "ç«¹ç”°é„‰",
        "ç‰¡ä¸¹é„‰",
        "è»ŠåŸŽé„‰",
        "é‡Œæ¸¯é„‰",
        "ä½³å†¬é„‰",
        "ä¾†ç¾©é„‰",
        "æ±æ¸¯éŽ®",
        "æž‹å±±é„‰",
        "æž‹å¯®é„‰",
        "æž—é‚Šé„‰",
        "é•·æ²»é„‰",
        "å—å·žé„‰",
        "å±æ±å¸‚",
        "æ†æ˜¥éŽ®",
        "æ˜¥æ—¥é„‰",
        "å´é ‚é„‰",
        "æ³°æ­¦é„‰",
        "ç‰çƒé„‰",
        "é«˜æ¨¹é„‰",
        "æ–°åŸ¤é„‰",
        "æ–°åœ’é„‰",
        "ç…å­é„‰",
        "è¬ä¸¹é„‰",
        "è¬å·’é„‰",
        "æ»¿å·žé„‰",
        "ç‘ªå®¶é„‰",
        "æ½®å·žéŽ®",
        "éœ§è‡ºé„‰",
        "éºŸæ´›é„‰",
        "é¹½åŸ”é„‰",
    ],       
    "å®œè˜­ç¸£": [
        "ä¸‰æ˜Ÿé„‰",
        "å¤§åŒé„‰",
        "äº”çµé„‰",
        "å†¬å±±é„‰",
        "å£¯åœé„‰",
        "å®œè˜­å¸‚",
        "å—æ¾³é„‰",
        "å“¡å±±é„‰",
        "é ­åŸŽéŽ®",
        "ç¤æºªé„‰",
        "ç¾…æ±éŽ®",
        "è˜‡æ¾³éŽ®",
    ],                    
    "èŠ±è“®ç¸£": [
        "çŽ‰é‡ŒéŽ®",
        "å…‰å¾©é„‰",
        "å‰å®‰é„‰",
        "ç§€æž—é„‰",
        "å“æºªé„‰",
        "èŠ±è“®å¸‚",
        "å¯Œé‡Œé„‰",
        "æ–°åŸŽé„‰",
        "ç‘žç©—é„‰",
        "è¬æ¦®é„‰",
        "å£½è±é„‰",
        "é³³æž—éŽ®",
        "è±æ¿±é„‰",        
    ],                    
    "è‡ºæ±ç¸£": [
        "å¤§æ­¦é„‰",
        "å¤ªéº»é‡Œé„‰",
        "æˆåŠŸéŽ®",
        "æ± ä¸Šé„‰",
        "å‘å—é„‰",
        "å»¶å¹³é„‰",
        "æ±æ²³é„‰",
        "é‡‘å³°é„‰",
        "é•·æ¿±é„‰",
        "æµ·ç«¯é„‰",
        "é¹¿é‡Žé„‰",
        "é”ä»é„‰",
        "ç¶ å³¶é„‰",
        "è‡ºæ±å¸‚",
        "é—œå±±éŽ®",
        "è˜­å¶¼é„‰",
    ],          
    "åŸºéš†å¸‚": [
        "ä¸ƒå µå€",
        "ä¸­å±±å€",
        "ä¸­æ­£å€",
        "ä»æ„›å€",
        "å®‰æ¨‚å€",
        "ä¿¡ç¾©å€",
        "æš–æš–å€",
    ],    
    "æ–°ç«¹å¸‚": [
        "åŒ—å€",
        "æ±å€",
        "é¦™å±±å€",        
    ],    
    "å˜‰ç¾©å¸‚": [
        "è¥¿å€",
        "æ±å€",
    ],  
    "æ¾Žæ¹–ç¸£": [
        "ä¸ƒç¾Žé„‰",
        "ç™½æ²™é„‰",
        "è¥¿å¶¼é„‰",
        "é¦¬å…¬å¸‚",
        "æœ›å®‰é„‰",
        "æ¹–è¥¿é„‰",
    ],    
    "é‡‘é–€ç¸£": [
        "é‡‘æ²™éŽ®",
        "é‡‘åŸŽéŽ®",
        "é‡‘æ¹–éŽ®",
        "é‡‘å¯§é„‰",
        "çƒˆå¶¼é„‰",
        "çƒåµé„‰",
    ],
    "é€£æ±Ÿç¸£": [
        "åŒ—ç«¿é„‰",
        "æ±å¼•é„‰",
        "å—ç«¿é„‰",
        "èŽ’å…‰é„‰",
    ],
    
}
# =========================
# è¼‰å…¥æ¨¡åž‹ï¼ˆå¿«å–ï¼‰
# =========================
@st.cache_resource
def load_predictor():
    return HousePricePredictor()

predictor = load_predictor()

# =========================
# å´é‚Šæ¬„è¼¸å…¥
# =========================
st.sidebar.header("ðŸ“‹ æˆ¿å±‹åŸºæœ¬è³‡æ–™")

# --- è¡Œæ”¿å€ï¼ˆæ‹†æˆå…©æ¬„ï¼‰ ---
city = st.sidebar.selectbox(
    "ç¸£å¸‚",
    list(CITY_TOWN_MAP.keys()),
)

town = st.sidebar.selectbox(
    "é„‰éŽ®å¸‚å€",
    CITY_TOWN_MAP[city],
)

# â­ åˆä½µæˆæ¨¡åž‹éœ€è¦çš„æ ¼å¼
district = f"{city}{town}"
st.sidebar.caption(f"ðŸ“ è¡Œæ”¿å€ï¼š{district}")

# --- å…¶ä»–æ¬„ä½ ---
building_type = st.sidebar.selectbox(
    "å»ºç‰©åž‹æ…‹",
    ["ä½å®…å¤§æ¨“", "è¯å»ˆ", "å…¬å¯“", "é€å¤©åŽ"],
)

main_use = st.sidebar.selectbox(
    "ä¸»è¦ç”¨é€”",
    ["ä½å®¶ç”¨", "å•†æ¥­ç”¨", "ä½å•†ç”¨"],
)

building_age = st.sidebar.number_input(
    "å±‹é½¡ï¼ˆå¹´ï¼‰",
    min_value=0,
    max_value=80,
    value=20,
)

main_area = st.sidebar.number_input(
    "ä¸»å»ºç‰©é¢ç©ï¼ˆåªï¼‰",
    min_value=5.0,
    max_value=100.0,
    value=30.0,
)

balcony_area = st.sidebar.number_input(
    "é™½å°é¢ç©ï¼ˆåªï¼‰",
    min_value=0.0,
    max_value=20.0,
    value=5.0,
)

floor = st.sidebar.number_input(
    "æ‰€åœ¨æ¨“å±¤",
    min_value=1,
    max_value=100,
    value=5,
)

total_floors = st.sidebar.number_input(
    "ç¸½æ¨“å±¤æ•¸",
    min_value=1,
    max_value=100,
    value=10,
)

has_parking = st.sidebar.radio(
    "æ˜¯å¦æœ‰è»Šä½",
    ["æœ‰", "ç„¡"],
)

has_elevator = st.sidebar.radio(
    "æ˜¯å¦æœ‰é›»æ¢¯",
    ["æœ‰", "ç„¡"],
)

# =========================
# çµ„åˆè¼¸å…¥è³‡æ–™
# =========================
case_dict = {
    "district": district,
    "building_type": building_type,
    "main_use": main_use,
    "building_age": building_age,
    "building_area_sqm": main_area * 3.3058,
    "floor": floor,
    "total_floors": total_floors,
    "main_area": main_area,
    "balcony_area": balcony_area,
    "has_parking": 1 if has_parking == "æœ‰" else 0,
    "has_elevator": 1 if has_elevator == "æœ‰" else 0,
}

# =========================
# ä¸»ç•«é¢
# =========================
st.subheader("ðŸ“Š é æ¸¬çµæžœ")

if st.button("ðŸš€ é–‹å§‹ä¼°åƒ¹"):

    with st.spinner("æ¨¡åž‹é æ¸¬ä¸­ï¼Œè«‹ç¨å€™..."):
        output_dir = predictor.export_prediction_bundle(case_dict)

    # --- è®€å–çµæžœ ---
    with open(os.path.join(output_dir, "prediction.json"), encoding="utf-8") as f:
        summary = json.load(f)

    with open(os.path.join(output_dir, "explanation.txt"), encoding="utf-8") as f:
        explanation = f.read()

    # ====== é¡¯ç¤ºé æ¸¬åƒ¹æ ¼ ======
    st.success(f"ðŸ’° é æ¸¬å–®åƒ¹ï¼šç´„ **{summary['predicted_price_wan_per_ping']} è¬ / åª**")

    # ====== SHAP åœ– ======
    st.subheader("ðŸ” åƒ¹æ ¼å½±éŸ¿å› ç´ ï¼ˆSHAPï¼‰")
    st.image(
        os.path.join(output_dir, "shap_waterfall.png"),
        use_container_width=True,
    )

    # ====== ä¸­æ–‡è§£é‡‹ ======
    st.subheader("ðŸ“ ä¸­æ–‡ä¼°åƒ¹èªªæ˜Ž")
    st.text(explanation)

    # ====== ä¸‹è¼‰å€ ======
    st.subheader("â¬‡ï¸ ä¸‹è¼‰çµæžœ")

    with open(os.path.join(output_dir, "explanation.txt"), "rb") as f:
        st.download_button(
            "ðŸ“„ ä¸‹è¼‰ä¼°åƒ¹èªªæ˜Žï¼ˆTXTï¼‰",
            f,
            file_name="prediction.txt",
        )

    with open(os.path.join(output_dir, "shap_waterfall.png"), "rb") as f:
        st.download_button(
            "ðŸ–¼ï¸ ä¸‹è¼‰ SHAP åœ–ï¼ˆPNGï¼‰",
            f,
            file_name="shap_waterfall.png",
        )

    with open(os.path.join(output_dir, "prediction.json"), "rb") as f:
        st.download_button(
            "ðŸ“¦ ä¸‹è¼‰ JSONï¼ˆAPI ç”¨ï¼‰",
            f,
            file_name="prediction.json",
        )

>>>>>>> 1df78f51412175b3bccafb94034672043ab8021b
